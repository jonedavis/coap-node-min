var CONSTANTS={TTYPE:{root:0,obj:1,inst:2,rsc:3},TAG:{notfound:"_notfound_",unreadable:"_unreadable_",exec:"_exec_",unwritable:"_unwritable_",unexecutable:"_unexecutable_"},ERR:{success:0,notfound:1,unreadable:2,unwritable:3,unexecutable:4,timeout:5,badtype:6},RSP:{created:"2.01",deleted:"2.02",changed:"2.04",content:"2.05",badreq:"4.00",unauth:"4.01",forbid:"4.03",notfound:"4.04",notallowed:"4.05",timeout:"4.08",serverError:"5.00"}};module.exports=CONSTANTS;var urlParser=require("url").parse,lwm2mId=require("lwm2m-id"),lwm2mCodec=require("lwm2m-codec"),_=require("busyman"),cutils={getTime:function(){return Math.round((new Date).getTime()/1e3)},oidKey:function(oid){var oidItem=lwm2mId.getOid(oid);return oidItem?oidItem.key:oid},oidNumber:function(oid){var oidItem=lwm2mId.getOid(oid);return oidItem=oidItem?oidItem.value:parseInt(oid),_.isNaN(oidItem)&&(oidItem=oid),oidItem},ridKey:function(oid,rid){var ridItem=lwm2mId.getRid(oid,rid);return _.isUndefined(rid)&&(rid=oid),ridItem?ridItem.key:rid},ridNumber:function(oid,rid){var ridItem=lwm2mId.getRid(oid,rid);return _.isUndefined(rid)&&(rid=oid),ridItem=ridItem?ridItem.value:parseInt(rid),_.isNaN(ridItem)&&(ridItem=rid),ridItem},buildRptAttr:function(req){var allowedAttrs=["pmin","pmax","gt","lt","stp"],attrs={},queryParams=urlParser(req.url).query.split("&");return _.forEach(queryParams,function(queryParam,idx){queryParams[idx]=queryParam.split("=")}),_.forEach(queryParams,function(queryParam){if(!_.includes(allowedAttrs,queryParam[0]))return!1;attrs[queryParam[0]]=Number(queryParam[1])}),attrs},buildUpdateQuery:function(attrs){var query="";return _.forEach(attrs,function(val,key){"lifetime"===key||"lt"===key?query+="lt="+val+"&":"version"!==key&&"lwm2m"!==key||(query+="lwm2m="+val+"&")}),"&"===query[query.length-1]&&(query=query.slice(0,query.length-1)),query},getArrayArgus:function(argusInPlain){var argusInArray=[],notallowed=[" ",'"',"'","\\"],isAnyNotallowed=!1;function chkCharSyntax(string){_.forEach(notallowed,function(val){_.includes(string,val)&&(isAnyNotallowed=!0)})}return 0===argusInPlain.length?[]:(Number(argusInPlain)&&(argusInPlain=argusInPlain.toString()),_.forEach(argusInPlain.split(","),function(argu){Number(argu)?argusInArray.push(Number(argu)):(_.includes(argu,"=")?argusInArray.push(argu.split("=")[1].slice(1,argu.length-1)):argusInArray.push(argu.slice(1,argu.length-1)),chkCharSyntax(argusInArray[argusInArray.length-1]))}),!isAnyNotallowed&&argusInArray)},chkPathSlash:function(path){return"/"===path.charAt(0)?path:"/"+path},urlParser:function(url){return{pathname:url.split("?")[0],query:url.split("?")[1]}},getPathArray:function(url){var pathArray=urlParser(url).pathname.split("/");return""===pathArray[0]&&(pathArray=pathArray.slice(1)),""===pathArray[pathArray.length-1]&&(pathArray=pathArray.slice(0,pathArray.length-1)),pathArray},getPathIdKey:function(url){var oid,rid,pathArray=this.getPathArray(url),pathObj={};return url&&pathArray[0]&&(oid=this.oidKey(pathArray[0]),pathObj.oid=oid,pathArray[1]&&(pathObj.iid=+pathArray[1],pathArray[2]&&(rid=this.ridKey(oid,pathArray[2]),pathObj.rid=rid))),pathObj},getPathDateType:function(path){return["so","object","instance","resource"][this.getPathArray(path).length]},encodeLinkFormat:function(path,value,attrs){return lwm2mCodec.encode("link",path,value,attrs)},encodeTlv:function(path,value){return lwm2mCodec.encode("tlv",path,value)},decodeTlv:function(path,value){return lwm2mCodec.decode("tlv",path,value)},encodeJson:function(path,value){return lwm2mCodec.encode("json",path,value)},decodeJson:function(path,value){return lwm2mCodec.decode("json",path,value)}};module.exports=cutils;_=require("busyman"),cutils=require("./cutils");var TTYPE=(CNST=require("./constants")).TTYPE,TAG=CNST.TAG,ERR=CNST.ERR,RSP=CNST.RSP;function chackResourceAttrs(val,gt,lt,step,lastRpVal){var chkRp=!1;return _.isObject(val)?_.isObject(lastRpVal)?_.forEach(lastRpVal,function(v,k){chkRp=chkRp||v!==lastRpVal[k]}):chkRp=!0:_.isNumber(val)?(chkRp=_.isNumber(gt)&&_.isNumber(lt)&&gt<lt?lastRpVal!==val&&gt<val&&val<lt:_.isNumber(gt)&&_.isNumber(lt)?(chkRp=_.isNumber(gt)&&lastRpVal!==val&&gt<val)||_.isNumber(lt)&&lastRpVal!==val&&val<lt:lastRpVal!==val,_.isNumber(step)&&(chkRp=Math.abs(val-lastRpVal)>step)):chkRp=lastRpVal!==val,chkRp}(helper={}).lfUpdate=function(cn,enable){clearInterval(cn._updater),cn._updater=null,enable&&(cn._updater=setInterval(function(){_.forEach(cn.serversInfo,function(serverInfo,ssid){serverInfo.registered&&(serverInfo.lfsecs+=1,serverInfo._lfsecs>=cn.lifetime-10&&(cn.update({},function(err,msg){err&&cn.emit("error",err)}),serverInfo._lfsecs=0))})},1e3))},helper.heartbeat=function(cn,ssid,enable,rsp){var serverInfo=cn.serversInfo[ssid];clearInterval(serverInfo.hbPacemaker),serverInfo.hbPacemaker=null,serverInfo.hbStream.stream&&(serverInfo.hbStream.stream.removeListener("finish",serverInfo.hbStream.finishCb),serverInfo.hbStream.stream.end(),serverInfo.hbStream.stream=null,cn.emit("logout")),enable&&(serverInfo.hbStream.stream=rsp,serverInfo.hbStream.finishCb=function(){clearInterval(serverInfo.hbPacemaker),cn.emit("offline"),!0===cn.autoReRegister&&helper.reRegister(cn,ssid)},rsp.on("finish",serverInfo.hbStream.finishCb),serverInfo.hbPacemaker=setInterval(function(){try{serverInfo.hbStream.stream.write("hb")}catch(e){cn.emit("error",e)}},1e3*cn._config.heartbeatTime),cn.emit("login"))},helper.reRegister=function(cn,ssid){var serverInfo=cn.serversInfo[ssid];cn.emit("reconnect"),cn._register(serverInfo.ip,serverInfo.port,function(err,msg){msg&&msg.status===RSP.created||setTimeout(function(){helper.reRegister(cn)},5e3)})},helper.checkAndBuildObjList=function(cn,check,opts){var objList=cn.getSmartObject().objectList(),objListInPlain="",newObjList={};return _.forEach(objList,function(rec){newObjList[rec.oid]=rec.iid}),!_.isEmpty(cn.objList)&&_.isEqual(cn.objList,newObjList)&&!0===check?null:(cn.objList=newObjList,opts&&(objListInPlain+="</>",_.forEach(opts,function(val,key){"ct"===key&&"application/json"===val?objListInPlain+=";ct=11543":"hb"===key&&!0===val&&(objListInPlain+=";hb")}),objListInPlain+=","),_.forEach(newObjList,function(iidArray,oidNum){var oidNumber=oidNum;0!==oidNum&&"0"!==oidNum&&(_.isEmpty(iidArray)?objListInPlain+="</"+oidNumber+">,":_.forEach(iidArray,function(iid){objListInPlain+="</"+oidNumber+"/"+iid+">,"}))}),","===objListInPlain[objListInPlain.length-1]&&(objListInPlain=objListInPlain.slice(0,objListInPlain.length-1)),objListInPlain)},helper.checkAndReportResrc=function(cn,oid,iid,rid,val){_.forEach(cn.serversInfo,function(serverInfo,ssid){helper._checkAndReportResrc(cn,ssid,oid,iid,rid,val)})},helper._checkAndReportResrc=function(cn,ssid,oid,iid,rid,val){var lastRpVal,chkRp,serverInfo=cn.serversInfo[ssid],target=cn._target(oid,iid,rid),oidKey=target.oidKey,ridKey=target.ridKey,rAttrs=cn._getAttrs(ssid,oid,iid,rid),iAttrs=cn._getAttrs(ssid,oid,iid),rpt=serverInfo.reporters[target.pathKey],iRpt=serverInfo.reporters[oidKey+"/"+iid],iObj={};if(!rAttrs.enable&&!iAttrs.enable)return!1;lastRpVal=_.isNil(rAttrs.lastRpVal)?iAttrs.lastRpVal[ridKey]:rAttrs.lastRpVal,chkRp=chackResourceAttrs(val,rAttrs.gt,rAttrs.lt,rAttrs.stp,lastRpVal),rAttrs.mute&&rAttrs.enable?setTimeout(function(){helper._checkAndReportResrc(cn,ssid,oid,iid,rid,val)},1e3*rAttrs.pmin):!rAttrs.mute&&chkRp&&rAttrs.enable&&_.isFunction(rpt.write)&&rpt.write(val),iAttrs.mute&&iAttrs.enable?setTimeout(function(){helper._checkAndReportResrc(cn,ssid,oid,iid,rid,val)},1e3*iAttrs.pmin):!iAttrs.mute&&chkRp&&iAttrs.enable&&_.isFunction(iRpt.write)&&(iObj[ridKey]=val,iRpt.write(iObj))},helper.checkAndCloseServer=function(cn,enable){clearInterval(cn._socketServerChker),cn._socketServerChker=null,enable&&(cn._socketServerChker=setInterval(function(){_.forEach(cn.servers,function(server,key){var using=!1;_.forEach(cn.serverInfo,function(serverInfo){_.forEach(serverInfo.reporters,function(reporter,path){server._port===reporter.port&&(using=!0)})}),!1===using&&server._port!==cn.port&&(server.close(),cn.servers[key]=null,delete cn.servers[key])})},1e3*cn._config.serverChkTime))},module.exports=helper;_=require("busyman");var debug=require("debug")("coap-node:reqHdlr"),helper=(cutils=require("./cutils"),require("./helper"));TTYPE=(CNST=require("./constants")).TTYPE,TAG=CNST.TAG,ERR=CNST.ERR,RSP=CNST.RSP;function serverReqHandler(cn,req,rsp){var reqHdlr,optType=serverReqParser(req),bootstrapping=cn._bootstrapping&&req.rsinfo.address===cn.bsServer.ip&&req.rsinfo.port===cn.bsServer.port,serverInfo=findServer(cn,req.rsinfo),bsSequence=!1;switch(optType){case"read":reqHdlr=serverReadHandler;break;case"discover":reqHdlr=serverDiscoverHandler;break;case"write":bootstrapping?(bsSequence=!0,reqHdlr=serverBsWriteHandler):reqHdlr=serverWriteHandler;break;case"writeAttr":reqHdlr=serverWriteAttrHandler;break;case"execute":reqHdlr=serverExecuteHandler;break;case"observe":reqHdlr=serverObserveHandler;break;case"cancelObserve":reqHdlr=serverCancelObserveHandler;break;case"ping":reqHdlr=serverPingHandler;break;case"create":reqHdlr=serverCreateHandler;break;case"delete":bootstrapping?(bsSequence=!0,reqHdlr=serverBsDeleteHandler):reqHdlr=serverDeleteHandler;break;case"finish":bootstrapping?(bsSequence=!0,reqHdlr=serverFinishHandler):rsp.reset();break;case"announce":reqHdlr=serverAnnounceHandler;break;case"empty":rsp.reset()}!serverInfo||cn._bootstrapping&&!bsSequence?rsp.reset():reqHdlr&&setImmediate(function(){reqHdlr(cn,req,rsp,serverInfo)})}function serverReadHandler(cn,req,rsp){var dataAndOpt,pathObj=cutils.getPathIdKey(req.url),target=cn._target(pathObj.oid,pathObj.iid,pathObj.rid);function readCallback(err,data){err?(rsp.code=data===TAG.unreadable||data===TAG.exec?RSP.notallowed:RSP.badreq,rsp.end(data)):(rsp.code=RSP.content,dataAndOpt=getRspDataAndOption(req,data),rsp.setOption("Content-Format",dataAndOpt.option["Content-Format"]),rsp.end(dataAndOpt.data))}0===pathObj.oid||"lwm2mSecurity"===pathObj.oid?(rsp.code=RSP.notallowed,rsp.end()):target.exist?target.type===TTYPE.obj?cn.so.dump(pathObj.oid,{restrict:!0},readCallback):target.type===TTYPE.inst?cn.so.dump(pathObj.oid,pathObj.iid,{restrict:!0},readCallback):target.type===TTYPE.rsc&&cn.so.read(pathObj.oid,pathObj.iid,pathObj.rid,{restrict:!0},readCallback):(rsp.code=RSP.notfound,rsp.end())}function serverDiscoverHandler(cn,req,rsp,serverInfo){var rspPayload,pathObj=cutils.getPathIdKey(req.url);cn._target(pathObj.oid,pathObj.iid,pathObj.rid).exist?(rspPayload=buildAttrsAndRsc(cn,serverInfo.shortServerId,pathObj.oid,pathObj.iid,pathObj.rid),rsp.code=RSP.content,rsp.setOption("Content-Format","application/link-format"),rsp.end(rspPayload)):(rsp.code=RSP.notfound,rsp.end())}function serverBsWriteHandler(cn,req,rsp){var pathObj=cutils.getPathIdKey(req.url),target=cn._target(pathObj.oid,pathObj.iid,pathObj.rid),value=getReqData(req,target.pathKey),obj={};target.type===TTYPE.obj?rsp.code=RSP.notallowed:(target.type===TTYPE.inst?cn.createInst(pathObj.oid,pathObj.iid,value):(obj[pathObj.rid]=value,cn.createInst(pathObj.oid,pathObj.iid,obj)),rsp.code=RSP.changed),rsp.end()}function serverWriteHandler(cn,req,rsp){var pathObj=cutils.getPathIdKey(req.url),target=cn._target(pathObj.oid,pathObj.iid,pathObj.rid),value=getReqData(req,target.pathKey);function writeCallback(err,data){rsp.code=err?data===TAG.unwritable||data===TAG.exec?RSP.notallowed:RSP.badreq:RSP.changed,rsp.end()}target.exist?target.type===TTYPE.obj?(rsp.code=RSP.notallowed,rsp.end()):target.type===TTYPE.inst?cn._writeInst(pathObj.oid,pathObj.iid,value,writeCallback):cn.so.write(pathObj.oid,pathObj.iid,pathObj.rid,value,{restrict:!0},writeCallback):(rsp.code=RSP.notfound,rsp.end())}function serverWriteAttrHandler(cn,req,rsp,serverInfo){var pathObj=cutils.getPathIdKey(req.url),target=cn._target(pathObj.oid,pathObj.iid,pathObj.rid),attrs=cutils.buildRptAttr(req);target.exist?!1===attrs?rsp.code=RSP.badreq:(cn._setAttrs(serverInfo.shortServerId,pathObj.oid,pathObj.iid,pathObj.rid,attrs),rsp.code=RSP.changed):rsp.code=RSP.notfound,rsp.end()}function serverExecuteHandler(cn,req,rsp){var pathObj=cutils.getPathIdKey(req.url),target=cn._target(pathObj.oid,pathObj.iid,pathObj.rid),argus=cutils.getArrayArgus(req.payload);target.exist?!1===argus?(rsp.code=RSP.badreq,rsp.end()):target.type===TTYPE.obj||target.type===TTYPE.inst?(rsp.code=RSP.notallowed,rsp.end()):cn.execResrc(pathObj.oid,pathObj.iid,pathObj.rid,argus,function(err,data){rsp.code=err?data===TAG.unexecutable?RSP.notallowed:RSP.badreq:RSP.changed,rsp.end()}):(rsp.code=RSP.notfound,rsp.end())}function serverObserveHandler(cn,req,rsp,serverInfo){var dataAndOpt,pathObj=cutils.getPathIdKey(req.url),ssid=serverInfo.shortServerId,target=cn._target(pathObj.oid,pathObj.iid,pathObj.rid);cn._getAttrs(ssid,pathObj.oid,pathObj.iid,pathObj.rid);function enableReport(oid,iid,rid,format,rsp){cn._enableReport(ssid,oid,iid,rid,format,rsp,function(err,val){err?(rsp.statusCode=val===TAG.unreadable||val===TAG.exec?RSP.notallowed:RSP.notfound,rsp.end(val)):(rsp.statusCode=RSP.content,dataAndOpt=getRspDataAndOption(req,val),rsp.setOption("Content-Format",dataAndOpt.option["Content-Format"]),rsp.write(dataAndOpt.data))})}"heartbeat"===pathObj.oid?(helper.heartbeat(cn,ssid,!0,rsp),rsp.statusCode=RSP.content,rsp.write("hb")):target.exist?target.type===TTYPE.obj?(rsp.statusCode=RSP.notallowed,rsp.end()):serverInfo.reporters[target.pathKey]?cn._disableReport(ssid,pathObj.oid,pathObj.iid,pathObj.rid,function(err){enableReport(pathObj.oid,pathObj.iid,pathObj.rid,req.headers.Accept,rsp)}):enableReport(pathObj.oid,pathObj.iid,pathObj.rid,req.headers.Accept,rsp):(rsp.statusCode=RSP.notfound,rsp.end())}function serverCancelObserveHandler(cn,req,rsp,serverInfo){var pathObj=cutils.getPathIdKey(req.url),target=cn._target(pathObj.oid,pathObj.iid,pathObj.rid);"heartbeat"===pathObj.oid?(helper.heartbeat(cn,!1),rsp.code=RSP.content,rsp.end()):target.exist?target.type===TTYPE.obj?(rsp.statusCode=RSP.notallowed,rsp.end()):cn._disableReport(serverInfo.shortServerId,pathObj.oid,pathObj.iid,pathObj.rid,function(err,val){rsp.code=err?RSP.notfound:RSP.content,rsp.end()}):(rsp.code=RSP.notfound,rsp.end())}function serverPingHandler(cn,req,rsp,serverInfo){rsp.code=serverInfo.registered?RSP.content:RSP.notallowed,rsp.end()}function serverCreateHandler(cn,req,rsp){var pathObj=cutils.getPathIdKey(req.url),target=cn._target(pathObj.oid,pathObj.iid),data=getReqData(req,target.pathKey),value=data[Object.keys(data)],iid=Object.keys(data)[0];target.exist?cn.createInst(pathObj.oid,iid,value,function(err,data){rsp.code=err?RSP.badreq:RSP.created,rsp.end()}):(rsp.code=RSP.badreq,rsp.end())}function serverBsDeleteHandler(cn,req,rsp){var objList,oid,pathObj=cutils.getPathIdKey(req.url);_.isNil(pathObj.oid)||_.isNil(pathObj.iid)?(objList=cn.so.objectList(),_.forEach(objList,function(obj){switch(oid=obj.oid){case 0:case 1:case 2:case 4:case 5:case 6:case 7:_.forEach(obj.iid,function(iid){cn.deleteInst(oid,iid)}),delete cn.so[cutils.oidKey(oid)]}})):cn.deleteInst(pathObj.oid,pathObj.iid),rsp.code=RSP.deleted,rsp.end()}function serverDeleteHandler(cn,req,rsp){var pathObj=cutils.getPathIdKey(req.url);_.isNil(pathObj.oid)&&_.isNil(pathObj.iid)?cn.deleteInst(pathObj.oid,pathObj.iid,function(err){rsp.code=err?RSP.badreq:RSP.deleted,rsp.end()}):(rsp.code=RSP.notallowed,rsp.end())}function serverFinishHandler(cn,req,rsp){cn.so.dumpSync("lwm2mSecurity"),cn.so.dumpSync("lwm2mServer");rsp.code=RSP.changed,rsp.end("finish"),cn._bootstrapping=!1,cn.emit("bootstrapped")}function serverAnnounceHandler(cn,req,rsp){cn.emit("announce",req.payload)}function serverReqParser(req){var optType;if("0.00"===req.code&&req._packet.confirmable&&0===req.payload.length)optType="empty";else switch(req.method){case"GET":optType=0===req.headers.Observe?"observe":1===req.headers.Observe?"cancelObserve":"application/link-format"===req.headers.Accept?"discover":"read";break;case"PUT":optType=req.headers["Content-Format"]?"write":"writeAttr";break;case"POST":optType="/ping"===req.url?"ping":"/bs"===req.url?"finish":"/announce"===req.url?"announce":req.headers["Content-Format"]?"create":"execute";break;case"DELETE":optType="delete";break;default:optType="empty"}return optType}function getRspDataAndOption(req,originalData){var format,data;return"text/plain"===req.headers.Accept?(format="text/plain",data=_.isBoolean(originalData)?originalData?"1":"0":originalData.toString()):"application/json"===req.headers.Accept?(format="application/json",data=cutils.encodeJson(req.url,originalData)):(format="application/tlv",data=cutils.encodeTlv(req.url,originalData)),{data:data,option:{"Content-Format":format}}}function getReqData(req,path){return"application/json"===req.headers["Content-Format"]?cutils.decodeJson(path,req.payload):"application/tlv"===req.headers["Content-Format"]?cutils.decodeTlv(path,req.payload):req.payload.toString()}function buildAttrsAndRsc(cn,ssid,oid,iid,rid){var value,attrs=cn._getAttrs(ssid,oid,iid,rid),target=cn._target(oid,iid,rid);return value=_.isNil(iid)?cn.getSmartObject().dumpSync(oid):cn.getSmartObject().dumpSync(oid,iid),cutils.encodeLinkFormat(target.pathKey,value,attrs)}function findServer(cn,rsinfo){var data;return _.forEach(cn.serversInfo,function(serverInfo,ssid){serverInfo.ip===rsinfo.address&&serverInfo.port===rsinfo.port&&(data=serverInfo)}),data||cn.bsServer.ip===rsinfo.address&&cn.bsServer.port===rsinfo.port&&(data=cn.bsServer),data}module.exports=serverReqHandler;var coap=require("coap"),init=(_=require("busyman"),helper=require("./components/helper"),{setupNode:function(cn,devResrcs){var propWritable={writable:!0,enumerable:!1,configurable:!1},maxLatency=(cn._config.reqTimeout-47)/2,so=cn.getSmartObject();coap.updateTiming({maxLatency:maxLatency}),coap.registerFormat("application/tlv",11542),coap.registerFormat("application/json",11543),so.init("device",0,{manuf:devResrcs.manuf||"sivann",model:devResrcs.model||"cnode-01",serial:devResrcs.serial||"c-0000",firmware:devResrcs.firmware||"1.0",devType:devResrcs.devType||"generic",hwVer:devResrcs.hwVer||"1.0",swVer:devResrcs.swVer||"1.0",availPwrSrc:devResrcs.availPwrSrc||0,pwrSrcVoltage:devResrcs.pwrSrcVoltage||100}),so.init("connMonitor",0,{ip:cn.ip,routeIp:"unknown"}),Object.defineProperty(so,"__read",{value:so.read},propWritable),Object.defineProperty(so,"read",{value:function(oid,iid,rid,opt,callback){var dataToCheck;return _.isFunction(opt)&&(callback=opt,opt=void 0),so.__read(oid,iid,rid,opt,function(err,data){dataToCheck=data,setImmediate(function(){helper.checkAndReportResrc(cn,oid,iid,rid,dataToCheck)}),callback(err,data)})}},propWritable),Object.defineProperty(so,"__write",{value:so.write},propWritable),Object.defineProperty(so,"write",{value:function(oid,iid,rid,value,opt,callback){var dataToCheck;return _.isFunction(opt)&&(callback=opt,opt=void 0),so.__write(oid,iid,rid,value,opt,function(err,data){dataToCheck=data||value,setImmediate(function(){helper.checkAndReportResrc(cn,oid,iid,rid,dataToCheck)}),callback(err,data)})}},propWritable),helper.lfUpdate(cn,!0),helper.checkAndCloseServer(cn,!1)}});module.exports=init,module.exports={defaultMinPeriod:0,defaultMaxPeriod:60,connectionType:"udp4",reqTimeout:60,heartbeatTime:30,serverChkTime:60};var util=require("util"),EventEmitter=require("events").EventEmitter,SmartObject=require("smartobject"),logReq=(_=require("busyman"),coap=require("coap"),debug=require("debug")("coap-node"),require("debug")("coap-node:request")),logRsp=require("debug")("coap-node:response"),reqHandler=require("./components/reqHandler"),CNST=(cutils=require("./components/cutils"),helper=require("./components/helper"),require("./components/constants")),config=require("./config");init=require("./init");if("test"===process.env.npm_lifecycle_event)var network={get_active_interface:function(cb){setTimeout(function(){cb(null,{ip_address:"127.0.0.1",gateway_ip:"192.168.1.1",mac_address:"00:00:00:00:00:00"})},100)}};else network=require("network");TTYPE=CNST.TTYPE,TAG=CNST.TAG,ERR=CNST.ERR,RSP=CNST.RSP;function CoapNode(clientName,smartObj,devAttrs){if(!_.isString(clientName))throw new TypeError("clientName should be a string.");if(!_.isObject(smartObj))throw new TypeError("smartObj should be a instance of SmartObject Class.");EventEmitter.call(this),devAttrs=devAttrs||{},this.servers={},this.serversIdTable={},this.serversInfo={},this.clientName=clientName,this.locationPath="unknown",this.ip="unknown",this.mac="unknown",this.port="unknown",this.version=devAttrs.version||"1.0",this.lifetime=devAttrs.lifetime||86400,this.bsServer={},this.objList=null,this.so=smartObj,this.autoReRegister=devAttrs.autoReRegister||!0,this._bootstrapping=!1,this._sleep=!1,this._updater=null,this._socketServerChker=null,this._config={reqTimeout:config.reqTimeout,heartbeatTime:config.heartbeatTime,serverChkTime:config.serverChkTime,connectionType:config.connectionType,defaultMinPeriod:config.defaultMinPeriod,defaultMaxPeriod:config.defaultMaxPeriod},init.setupNode(this,devAttrs)}function startListener(cn,port,callback){var server;server=coap.createServer({type:cn._config.connectionType,proxy:!0}),(cn.servers[port]=server).on("request",function(req,rsp){_.isEmpty(req.payload)||"application/json"!==req.headers["Content-Format"]?_.isEmpty(req.payload)||"application/tlv"!==req.headers["Content-Format"]?_.isEmpty(req.payload)||(req.payload=req.payload.toString()):req.payload=req.payload:req.payload=JSON.parse(req.payload),reqHandler(cn,req,rsp)});try{server.listen(port,function(err){err?_.isFunction(callback)?callback(err):cn.emit("error",err):callback(null,server)})}catch(e){callback(e)}}function removeReporter(cn,ssid,oid,iid,rid){var rpt,serverInfo=cn.serversInfo[ssid],key=cn._target(oid,iid,rid).pathKey,rAttrs=cn._getAttrs(ssid,oid,iid,rid);serverInfo&&((rpt=serverInfo.reporters[key])&&(clearTimeout(rpt.min),clearInterval(rpt.max),rpt.min=null,rpt.max=null,rpt.write=null,rpt.stream=null,rpt.port=null,delete serverInfo.reporters[key]),rAttrs.enable=!1,rAttrs.mute=!0)}function getServerUriInfo(uri){var uriArray=uri.split("://"),infoArray=uriArray[uriArray.length-1].split(":");return{address:infoArray[0],port:infoArray[1]}}function invokeCbNextTick(err,val,cb){_.isFunction(cb)&&process.nextTick(function(){cb(err,val)})}util.inherits(CoapNode,EventEmitter),CoapNode.prototype._updateNetInfo=function(callback){var self=this;network.get_active_interface(function(err,obj){err?callback(err):(self.ip=obj.ip_address,self.mac=obj.mac_address,self.so.set("connMonitor",0,"ip",self.ip),self.so.set("connMonitor",0,"routeIp",obj.gateway_ip||"unknown"),callback(null,{ip:obj.ip_address,mac:obj.mac_address,routeIp:obj.gateway_ip}))})},CoapNode.prototype.getSmartObject=function(){return this.so},CoapNode.prototype._writeInst=function(oid,iid,value,callback){var self=this,exist=this.so.has(oid,iid),dump=(cutils.oidKey(oid),{}),chkErr=null,count=_.keys(value).length;if(exist){if(_.forEach(value,function(rsc,rid){self.so.isWritable(oid,iid,rid)||"lwm2mSecurity"==oid||"lwm2mServer"==oid||(chkErr=chkErr||new Error("Resource is unwritable."))}),chkErr)return callback(chkErr,TAG.unwritable);_.forEach(value,function(rsc,rid){self.so.write(oid,iid,rid,rsc,function(err,data){if(count-=1,err?(chkErr=chkErr||err,dump=data,count=0):dump[cutils.ridNumber(oid,rid)]=data,0===count&&_.isFunction(callback))return callback(chkErr,dump)})})}else callback(ERR.notfound,null)},CoapNode.prototype.execResrc=function(oid,iid,rid,argus,callback){return this.so.exec(oid,iid,rid,argus,callback)},CoapNode.prototype.createInst=function(oid,iid,resrcs){return this.so.init(oid,iid,resrcs)},CoapNode.prototype.deleteInst=function(oid,iid){return this.so.remove(oid,iid)},CoapNode.prototype.configure=function(ip,port,opts){if(!_.isString(ip))throw new TypeError("ip should be a string.");if(!_.isString(port)&&!_.isNumber(port)||_.isNaN(port))throw new TypeError("port should be a string or a number.");var securityIid,serverIid,shortServerId,serversIdInfo=this.serversIdTable["coap://"+ip+":"+port];return opts||(opts={}),serversIdInfo?(securityIid=serversIdInfo.securityIid,serverIid=serversIdInfo.serverIid,shortServerId=serversIdInfo.shortServerId):(securityIid=this._idCounter("securityIid"),serverIid=this._idCounter("serverIid"),shortServerId=this._idCounter("shortServerId"),this.serversIdTable["coap://"+ip+":"+port]={securityIid:securityIid,serverIid:serverIid,shortServerId:shortServerId}),this.so.init("lwm2mSecurity",securityIid,{lwm2mServerURI:"coap://"+ip+":"+port,bootstrapServer:!1,securityMode:3,pubKeyId:"",serverPubKeyId:"",secretKey:"",shortServerId:shortServerId}),this.so.init("lwm2mServer",serverIid,{shortServerId:shortServerId,lifetime:opts.lifetime||this.lifetime,defaultMinPeriod:opts.pmax||this._config.defaultMinPeriod,defaultMaxPeriod:opts.pmin||this._config.defaultMaxPeriod,notificationStoring:!1,binding:"U"}),shortServerId},CoapNode.prototype.bootstrap=function(ip,port,callback){if(!_.isString(ip))throw new TypeError("ip should be a string.");if(!_.isString(port)&&!_.isNumber(port)||_.isNaN(port))throw new TypeError("port should be a string or a number.");var msg,self=this,reqObj={hostname:ip,port:port,pathname:"/bs",method:"POST"},agent=this._createAgent(),resetCount=(this._idCounter("securityIid"),this._idCounter("shortServerId"),0);reqObj.query="ep="+self.clientName,self.request(reqObj,agent,function(err,rsp){err?invokeCbNextTick(err,null,callback):(msg={status:rsp.code},rsp.code===RSP.changed?(self.bsServer={ip:rsp.rsinfo.address,port:rsp.rsinfo.port},self.ip=rsp.outSocket.ip,self.port=rsp.outSocket.port,self._bootstrapping=!0,function setListenerStart(port,msg){agent._sock?resetCount<10?(resetCount+=1,setTimeout(function(){return setListenerStart(port,msg)},10)):invokeCbNextTick(new Error("Socket can not be create."),null,callback):startListener(self,port,function(err){err?invokeCbNextTick(err,null,callback):(self._sleep=!1,invokeCbNextTick(null,msg,callback))})}(rsp.outSocket.port,msg)):invokeCbNextTick(null,msg,callback))})},CoapNode.prototype.registerAllCfg=function(callback){var serverInfo,chkErr,self=this,securityObjs=this.so.dumpSync("lwm2mSecurity"),serverObjs=this.so.dumpSync("lwm2mServer"),requestCount=0,requestInfo=[],rsps={status:null,data:[]};_.forEach(serverObjs,function(serverObj,iid){_.forEach(securityObjs,function(securityObj,iid){_.isNil(serverObj.shortServerId)||_.isNil(serverObj.shortServerId)||serverObj.shortServerId!==securityObj.shortServerId||securityObj.bootstrapServer||(requestInfo.push({uri:securityObj.lwm2mServerURI,ssid:securityObj.shortServerId}),requestCount+=1)})}),0===requestCount?invokeCbNextTick(new Error("Do not have any allowed configuration."),null,callback):_.forEach(requestInfo,function(info,key){serverInfo=getServerUriInfo(info.uri),self._register(serverInfo.address,serverInfo.port,info.ssid,function(err,msg){requestCount-=1,err?(chkErr=chkErr||err,requestCount=0):(msg.status===RSP.created?rsps.status=rsps.status||RSP.created:rsps.status=msg.status,rsps.data.push({shortServerId:info.ssid,status:msg.status})),0===requestCount&&(chkErr?invokeCbNextTick(chkErr,null,callback):invokeCbNextTick(null,rsps,callback))})})},CoapNode.prototype.register=function(ip,port,opts,callback){_.isFunction(opts)&&(callback=opts,opts=void 0);var ssid=this.configure(ip,port,opts);this._register(ip,port,ssid,callback)},CoapNode.prototype._register=function(ip,port,ssid,callback){if(!_.isString(ip))throw new TypeError("ip should be a string.");if(!_.isString(port)&&!_.isNumber(port)||_.isNaN(port))throw new TypeError("port should be a string or a number.");var msg,self=this,reqObj={hostname:ip,port:port,pathname:"/rd",payload:helper.checkAndBuildObjList(this,!1,{ct:"application/json",hb:!0}),method:"POST",options:{"Content-Format":"application/link-format"}},agent=this._createAgent(),resetCount=0;this._updateNetInfo(function(){reqObj.query="ep="+self.clientName+"&lt="+self.lifetime+"&lwm2m="+self.version+"&mac="+self.mac,self.request(reqObj,agent,function(err,rsp){err?invokeCbNextTick(err,null,callback):(msg={status:rsp.code},rsp.code===RSP.created?(self.serversInfo[ssid]={shortServerId:ssid,ip:rsp.rsinfo.address,port:rsp.rsinfo.port,locationPath:"/rd/"+rsp.headers["Location-Path"],registered:!0,lfsecs:0,repAttrs:{},reporters:{},hbPacemaker:null,hbStream:{stream:null,port:null,finishCb:null}},self.ip=rsp.outSocket.ip,self.port=rsp.outSocket.port,function setListenerStart(port,msg){agent._sock?resetCount<10?(resetCount+=1,setTimeout(function(){return setListenerStart(port,msg)},10)):invokeCbNextTick(new Error("Socket can not be create."),null,callback):startListener(self,port,function(err){err?invokeCbNextTick(err,null,callback):(self._sleep=!1,invokeCbNextTick(null,msg,callback),self.emit("registered"))})}(rsp.outSocket.port,msg)):invokeCbNextTick(null,msg,callback))})})},CoapNode.prototype.update=function(attrs,callback){if(!_.isPlainObject(attrs))throw new TypeError("attrs should be an object.");var objListInPlain,localStatus,chkErr,self=this,requestCount=Object.keys(this.serversInfo).length,updateObj={},rsps={status:null,data:[]};_.forEach(attrs,function(val,key){"lifetime"===key&&attrs.lifetime!==self.lifetime?self.lifetime=updateObj.lifetime=attrs.lifetime:localStatus=RSP.badreq}),objListInPlain=helper.checkAndBuildObjList(self,!0),_.isNil(objListInPlain)||(updateObj.objList=objListInPlain),localStatus?invokeCbNextTick(new Error("There is an unrecognized attribute within the attrs."),null,callback):_.forEach(this.serversInfo,function(serverInfo,ssid){self._update(serverInfo,updateObj,function(err,msg){requestCount-=1,err?(chkErr=chkErr||err,requestCount=0):(msg.status===RSP.changed?rsps.status=rsps.status||RSP.changed:rsps.status=msg.status,rsps.data.push({shortServerId:ssid,status:msg.status})),0===requestCount&&(chkErr?invokeCbNextTick(chkErr,null,callback):invokeCbNextTick(null,rsps,callback))})})},CoapNode.prototype._update=function(serverInfo,attrs,callback){if(!_.isPlainObject(attrs))throw new TypeError("attrs should be an object.");var msg,self=this,reqObj={hostname:serverInfo.ip,port:serverInfo.port,pathname:serverInfo.locationPath,query:cutils.buildUpdateQuery(attrs),payload:attrs.objList,method:"POST"},agent=this._createAgent(),resetCount=0;attrs.objList&&(reqObj.options={"Content-Format":"application/link-format"}),serverInfo.registered?this.request(reqObj,agent,function(err,rsp){err?invokeCbNextTick(err,null,callback):(msg={status:rsp.code},rsp.code===RSP.changed?(self.ip=rsp.outSocket.address,self.port=rsp.outSocket.port,function setListenerStart(port,msg){agent._sock?resetCount<10?(resetCount+=1,setTimeout(function(){setListenerStart(port,msg)},10)):invokeCbNextTick(new Error("Socket can not be create."),null,callback):startListener(self,port,function(err){err?invokeCbNextTick(err,null,callback):(self._sleep=!1,invokeCbNextTick(null,msg,callback))})}(rsp.outSocket.port,msg)):invokeCbNextTick(null,msg,callback))}):invokeCbNextTick(null,{status:RSP.notfound},callback)},CoapNode.prototype.deregister=function(ssid,callback){var chkErr,self=this,requestCount=Object.keys(this.serversInfo).length,rsps={status:null,data:[]};function deregister(serverInfo,cb){var reqObj={hostname:serverInfo.ip,port:serverInfo.port,pathname:serverInfo.locationPath,method:"DELETE"};!0===serverInfo.registered?self.request(reqObj,function(err,rsp){if(err)invokeCbNextTick(err,null,cb);else{var msg={status:rsp.code};rsp.code===RSP.deleted&&(self._disableAllReport(serverInfo.shortServerId),serverInfo.registered=!1,self.emit("deregistered")),invokeCbNextTick(null,msg,cb)}}):invokeCbNextTick(null,{status:RSP.notfound},cb)}_.isFunction(ssid)&&(callback=ssid,ssid=void 0),_.isNil(ssid)?_.forEach(this.serversInfo,function(serverInfo,ssid){deregister(serverInfo,function(err,msg){requestCount-=1,err?(chkErr=chkErr||err,requestCount=0):(msg.status===RSP.deleted?rsps.status=rsps.status||RSP.deleted:rsps.status=msg.status,rsps.data.push({shortServerId:ssid,status:msg.status})),0===requestCount&&(chkErr?invokeCbNextTick(chkErr,null,callback):invokeCbNextTick(null,rsps,callback))})}):this.serversInfo[ssid]?deregister(this.serversInfo[ssid],callback):invokeCbNextTick(null,{status:RSP.notfound},callback)},CoapNode.prototype.checkin=function(callback){var chkErr,self=this,agent=this._createAgent(),requestCount=Object.keys(this.serversInfo).length,resetCount=0,rsps={status:null,data:[]};function checkin(serverInfo,cb){var reqObj={hostname:serverInfo.ip,port:serverInfo.port,pathname:serverInfo.locationPath,query:"chk=in",method:"PUT"};!0===serverInfo.registered?self.request(reqObj,agent,function(err,rsp){if(err)invokeCbNextTick(err,null,cb);else{var msg={status:rsp.code};rsp.code===RSP.changed?(self.ip=rsp.outSocket.address,self.port=rsp.outSocket.port,self._sleep=!1,function setListenerStart(port,msg,cb){agent._sock?resetCount<10?(resetCount+=1,setTimeout(function(){setListenerStart(port,msg,cb)},10)):invokeCbNextTick(new Error("Socket can not be create."),null,cb):startListener(self,port,function(err){err?invokeCbNextTick(err,null,cb):invokeCbNextTick(null,msg,cb)})}(rsp.outSocket.port,msg,cb)):invokeCbNextTick(null,msg,cb)}}):invokeCbNextTick(null,{status:RSP.notfound},cb)}_.forEach(this.serversInfo,function(serverInfo,ssid){checkin(serverInfo,function(err,msg){requestCount-=1,err?(chkErr=chkErr||err,requestCount=0):(msg.status===RSP.changed?rsps.status=rsps.status||RSP.changed:rsps.status=msg.status,rsps.data.push({shortServerId:ssid,status:msg.status})),0===requestCount&&(chkErr?invokeCbNextTick(chkErr,null,callback):invokeCbNextTick(null,rsps,callback))})})},CoapNode.prototype.checkout=function(duration,callback){var chkErr,self=this,requestCount=Object.keys(this.serversInfo).length,rsps={status:null,data:[]};if(_.isFunction(duration)&&(callback=duration,duration=void 0),!(_.isUndefined(duration)||_.isNumber(duration)&&!_.isNaN(duration)))throw new TypeError("duration should be a number if given.");if(!_.isUndefined(callback)&&!_.isFunction(callback))throw new TypeError("callback should be a function if given.");_.forEach(this.serversInfo,function(serverInfo,ssid){!function(serverInfo,cb){var reqObj={hostname:serverInfo.ip,port:serverInfo.port,pathname:serverInfo.locationPath,query:duration?"chk=out&t="+duration:"chk=out",method:"PUT"};!0===serverInfo.registered?self.request(reqObj,function(err,rsp){if(err)invokeCbNextTick(err,null,cb);else{var msg={status:rsp.code};rsp.code===RSP.changed&&(self._disableAllReport(serverInfo.shortServerId),self._sleep=!0,_.forEach(self.servers,function(server,key){server.close()})),invokeCbNextTick(null,msg,cb)}}):invokeCbNextTick(null,{status:RSP.notfound},cb)}(serverInfo,function(err,msg){requestCount-=1,err?(chkErr=chkErr||err,requestCount=0):(msg.status===RSP.changed?rsps.status=rsps.status||RSP.changed:rsps.status=msg.status,rsps.data.push({shortServerId:ssid,status:msg.status})),0===requestCount&&(chkErr?invokeCbNextTick(chkErr,null,callback):invokeCbNextTick(null,rsps,callback))})})},CoapNode.prototype.lookup=function(ssid,clientName,callback){var serverInfo=this.serversInfo[ssid],reqObj={hostname:serverInfo.ip,port:serverInfo.port,pathname:"/rd-lookup/ep",query:"ep="+clientName,method:"GET"};this.request(reqObj,function(err,rsp){if(err)invokeCbNextTick(err,null,callback);else{var msg={status:rsp.code};rsp.code===RSP.content&&(msg.data=rsp.payload),invokeCbNextTick(null,msg,callback)}})},CoapNode.prototype.request=function(reqObj,ownAgent,callback){if(!_.isPlainObject(reqObj))throw new TypeError("reqObj should be an object.");_.isFunction(ownAgent)&&(callback=ownAgent,ownAgent=void 0);var self=this,req=(ownAgent||new coap.Agent({type:this._config.connectionType})).request(reqObj);req.on("response",function(rsp){_.isEmpty(rsp.payload)||(rsp.payload=rsp.payload.toString()),_.isFunction(callback)&&callback(null,rsp)}),req.on("error",function(err){_.isFunction(callback)?err.retransmitTimeout?callback(null,{code:RSP.timeout}):callback(err):self.emit("error",err)}),req.end(reqObj.payload)},CoapNode.prototype._createAgent=function(){return new coap.Agent({type:this._config.connectionType})},CoapNode.prototype._target=function(oid,iid,rid){var rkey,okey=cutils.oidKey(oid),trg={type:null,exist:this.so.has(oid,iid,rid),value:null,pathKey:null,oidKey:okey,ridKey:null};return _.isNil(oid)||(trg.type=TTYPE.obj,trg.pathKey=okey,_.isNil(iid)||(trg.type=TTYPE.inst,trg.pathKey=okey+"/"+iid,_.isNil(rid)||(trg.type=TTYPE.rsc,rkey=cutils.ridKey(oid,rid),trg.ridKey=rkey,trg.pathKey=okey+"/"+iid+"/"+rkey))),trg.exist&&(trg.type===TTYPE.obj?trg.value=this.so.findObject(oid):trg.type===TTYPE.inst?trg.value=this.so.findObjectInstance(oid,iid):trg.type===TTYPE.rsc&&(trg.value=this.so.get(oid,iid,rid))),trg},CoapNode.prototype._setAttrs=function(ssid,oid,iid,rid,attrs){if(!_.isPlainObject(attrs))throw new TypeError("attrs should be given as an object.");var target=this._target(oid,iid,rid),rAttrs=this._getAttrs(ssid,oid,iid,rid);target.pathKey;return rAttrs.pmin=_.isNumber(attrs.pmin)?attrs.pmin:rAttrs.pmin,rAttrs.pmax=_.isNumber(attrs.pmax)?attrs.pmax:rAttrs.pmax,rAttrs.gt=_.isNumber(attrs.gt)?attrs.gt:rAttrs.gt,rAttrs.lt=_.isNumber(attrs.lt)?attrs.lt:rAttrs.lt,rAttrs.stp=_.isNumber(attrs.stp)?attrs.stp:rAttrs.stp,this},CoapNode.prototype._getAttrs=function(ssid,oid,iid,rid){var defaultAttrs,serverInfo=this.serversInfo[ssid],key=this._target(oid,iid,rid).pathKey;return defaultAttrs={pmin:this._config.defaultMinPeriod,pmax:this._config.defaultMaxPeriod,mute:!0,enable:!1,lastRpVal:null},serverInfo.repAttrs[key]=serverInfo.repAttrs[key]||defaultAttrs,serverInfo.repAttrs[key]},CoapNode.prototype._enableReport=function(ssid,oid,iid,rid,format,rsp,callback){var rpt,dumper,self=this,serverInfo=this.serversInfo[ssid],target=this._target(oid,iid,rid),key=target.pathKey,rAttrs=this._getAttrs(ssid,oid,iid,rid),pmin=1e3*rAttrs.pmin,pmax=1e3*rAttrs.pmax;function reporterMin(){rAttrs.mute=!1}function reporterMax(){dumper(function(err,val){return err?self.emit("error",err):rpt.write(val)})}function reporterWrite(val){rAttrs.mute=!0,_.isObject(val)?_.forEach(val,function(val,rid){rAttrs.lastRpVal[rid]=val}):rAttrs.lastRpVal=val,val="text/plain"===format?_.isBoolean(val)?val?"1":"0":val.toString():"application/json"===format?cutils.encodeJson(key,val):cutils.encodeTlv(key,val);try{rsp.write(val)}catch(e){self.emit("error",e)}_.isNil(rpt.min)||clearTimeout(rpt.min),_.isNil(rpt.max)||clearInterval(rpt.max),rpt.min=setTimeout(reporterMin,pmin),rpt.max=setInterval(reporterMax,pmax)}function finishHdlr(){removeReporter(self,ssid,oid,iid,rid)}target.type===TTYPE.inst?dumper=function(cb){self.so.dump(oid,iid,cb)}:target.type===TTYPE.rsc&&(dumper=function(cb){self.so.read(oid,iid,rid,cb)}),dumper(function(err,data){err||data===TAG.unreadable||data===TAG.exec||(rAttrs.mute=!1,rAttrs.enable=!0,rAttrs.lastRpVal=data,rsp.once("finish",finishHdlr),rpt=serverInfo.reporters[key]={min:setTimeout(reporterMin,pmin),max:setInterval(reporterMax,pmax),write:reporterWrite,stream:rsp,port:self.port,finishHdlr:finishHdlr}),_.isFunction(callback)&&callback(err,data)})},CoapNode.prototype._disableReport=function(ssid,oid,iid,rid,callback){var rpt,chkErr,serverInfo=this.serversInfo[ssid],key=this._target(oid,iid,rid).pathKey;serverInfo&&(rpt=serverInfo.reporters[key]),rpt?(rpt.stream.removeListener("finish",rpt.finishHdlr),rpt.stream.end(),removeReporter(this,ssid,oid,iid,rid),chkErr=ERR.success):chkErr=ERR.notfound,_.isFunction(callback)&&callback(chkErr,null)},CoapNode.prototype._disableAllReport=function(ssid){var self=this;function disableReport(serverInfo){helper.heartbeat(self,serverInfo.shortServerId,!1),_.forEach(serverInfo.reporters,function(rpt,key){var oid=key.split("/")[0],iid=key.split("/")[1],rid=key.split("/")[2];self._disableReport(serverInfo.shortServerId,oid,iid,rid,function(err,result){err&&self.emit("error",err)})})}_.isNil(ssid)?_.forEach(this.serversInfo,function(serverInfo,ssid){disableReport(self)}):this.serversInfo[ssid]&&disableReport(this.serversInfo[ssid])},CoapNode.prototype._idCounter=function(type){var id,idUsed;switch(type){case"securityIid":for(id=1;this.so.has("lwm2mSecurity",id);)id+=1;break;case"serverIid":for(id=1;this.so.has("lwm2mServer",id);)id+=1;break;case"shortServerId":for(id=0;id+=1,idUsed=!1,_.forEach(this.so.dumpSync("lwm2mSecurity"),function(iObj,iid){iObj.shortServerId===id&&(idUsed=!0)}),idUsed;);}return id},module.exports=CoapNode;
